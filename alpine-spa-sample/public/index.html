<script type="module">
  import Mustache from "/js/mustache.js";
  window.Mustache = Mustache;
</script>
<script defer src="https://unpkg.com/alpinejs@3.2.3/dist/cdn.min.js"></script>

<script>
let parseQueryString = function( queryString ) {
    let params = {}, queries, temp, i, l;

    queries = queryString.split("&");

    for ( i = 0, l = queries.length; i < l; i++ ) {
        temp = queries[i].split('=');
        params[temp[0]] = decodeURIComponent(temp[1]);
    }

    return params;
};

window['__page_user'] = function() {
  return {
    user_id: -1,
    hello() {
      alert('hello~~~');
    }
  }
};

let _app_x_init = function(page) {
  let page_idx = "__page_" + page;
  let page_func = window[page_idx] || function() {return {}};
  let page_data = page_func();
  for (let key in page_data){
    let value = page_data[key];
    if(typeof value === 'function'){
      params[key] = value;
    }
  }
}

let app = function() {
    return {
        page: 'index',
        uri: '#',
        params: {},
        content: "loading...",
        loadPage() {
          let params = this.params;
          let page_idx = "__page_" + this.page;
          let page_func = window[page_idx] || function() {return {}};
          let page_data = page_func();
          for (let key in page_data){
            let value = params[key] || page_data[key];
            // if(typeof value === 'function'){
            //   value = value.toString();
            // }
            params[key] = value;
          }
          this.load_page(this.page, params);
        },
        load_page(page, data) {
          fetch('/page/'+page+'.html')
            .then((response) => response.text())
            .then((template) => {
              let dataStr = JSON.stringify(data)
              let content = Mustache.render(template, {data:dataStr});
              console.log(content);
              this.content = content;
            });
        },
        updatePageAndParams() {
            let hash = new URL(document.URL).hash;
            hash = hash.substring(1);
            let page = '';
            let params = {};
            let pos = hash.indexOf('?');
            if(pos == -1) {
              page = hash;
            }else{
              page = hash.substring(0, pos);
              let query_str = hash.substring(pos+ 1);
              params = parseQueryString(query_str);
            }
            page = page || 'index';
            this.params = params;
            this.page = page;
            this.uri = hash;
        },
        init(){
          this.updatePageAndParams();
          this.loadPage();
        }
    };
}

</script>

<body x-data="app()" @hashchange.window="updatePageAndParams()" >
<div x-html="content" x-init="$watch('uri', value => loadPage())"></div>
</body>